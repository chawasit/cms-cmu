{% import re %}
{% import time %}
{% import json %}
{% from cms import LANGUAGE_NAMES, LANGUAGE_TO_SOURCE_EXT_MAP %}
{% from cms.server import format_amount_of_time, format_time, format_datetime, format_datetime_smart, get_score_class, encode_for_url %}
{% from cmscommon.datetime import make_timestamp, utc %}
{% from cmscommon.isocodes import translate_language_country_code %}
{% from cms.grading import task_score %}
{% from cms.db import Session, Contest, User, Task, Submission %}
{% set sql_session = Session() %}
{% set contest_list = sql_session.query(Contest).all() %}

<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript"></script>
    <link rel="shortcut icon" href="./static/favicon.ico">
    <script type="text/javascript" src="./static/jq/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="./static/js/bootstrap.js"></script>
    <script type="text/javascript" src="./static/js/bootstrap-sortable.js"></script>
    <script type="text/javascript" src="./static/cws_utils.js"></script>
    <link rel="stylesheet" href="./static/css/bootstrap.css">
    <link rel="stylesheet" href="./static/css/bootstrap-sortable.css">
    <link href="./static/css/cosmo.css" rel="stylesheet" title="main">
    <link rel="stylesheet" href="./static/cws_style.css">
    <title>Ranking</title>
</head>
<body id="body">
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="./">AWS System</a>
            </div>
            <ul class="nav navbar-nav">
            </ul>
            <div class="navbar-right">
                <p class="navbar-text">
                </p>
            </div>
        </div>
    </nav>
    <div id="main" class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="page-header">
                    <h1>Ranking <small>overview</small></h1>
                </div>
                <div class="table-responsive">
                    <table id="submission_list" class="table table-bordered table-striped table-hover sortable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="az" data-defaultsign="nospan" data-defaultsort="asc">Name</th>
                        {% for c_iter in sorted(contest_list, key=lambda c: c.id) %}
                                <th colspan="{{ len(c_iter.tasks)+1 }}" data-mainsort="{{ len(c_iter.tasks)+1 }}">{{ c_iter.name }}</th>
                        {% end %}
                                <th rowspan="2">Global</th>
                            </tr>
                            <tr>
                        {% for c_iter in sorted(contest_list, key=lambda c: c.id) %}
                            {% for task in c_iter.tasks %}
                                <th>{{ task.name }}</th>
                            {% end %}
                            <th>Total</th>
                        {% end %}
                            </th>
                        </thead>
                        <tbody>
                        {% for user in sorted(contest.users, key=lambda u: u.username) %}
                            {% if not user.hidden %}
                                {% set total_score = 0.0 %}
                                <tr>
                                <td><a href="{{ url_root }}/user/{{ user.id }}">{{ "%s %s" % (user.first_name, user.last_name) }}</a></td>
                                {% for c_iter in sorted(contest_list, key=lambda c: c.id) %}
                                    {% set score = 0.0 %}
                                    {% set partial = False %}
                                    {% for task in c_iter.tasks %}
                                        {% set t_score, t_partial = task_score(user, task) %}
                                        {% set t_score = round(t_score, task.score_precision) %}
                                        {% set score += t_score %}
                                        {% set total_score += t_score %}
                                        {% set partial = partial or t_partial %}
                                        <td>{{ t_score }}{% if t_partial %}*{% end %}</td>
                                    {% end %}
                                    <td>{{ round(score, c_iter.score_precision) }}{% if partial %}*{% end %}</td>
                                {% end %}
                                <td>{{ total_score }}</td>
                                </tr>
                            {% end %}
                        {% end %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="footer">
            <span>Edited by Department of Computer Science, Chiang Mai University</span>
            <span id="server_time" class="pull-right"></span>
        </footer>
    </div>
</body>
</html>